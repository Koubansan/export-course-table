!function(){"use strict";var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};function e(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}var t,n,c=function(){function o(){this.events=""}return o.toICSDateString=function(e){return e.toISOString().replace(/[:-]/g,"").replace(/\.\d{3}/g,"")},o.prototype.addEvent=function(e,t,n,r,a){var i=new Date;this.events+="BEGIN:VEVENT\nUID:"+"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})+"@stormyyd.com\nDTSTAMP:"+o.toICSDateString(i)+"\nDTSTART:"+o.toICSDateString(r)+"\nDTEND:"+o.toICSDateString(a)+"\nSUMMARY:"+e+"\nDESCRIPTION:"+t+"\nLOCATION:"+n+"\nTRANSP:OPAQUE\nEND:VEVENT\n"},o.prototype.getCalendar=function(){return"BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:https://github.com/stormyyd\n"+this.events+"END:VCALENDAR"},o}(),a=function(i){function s(e,t){var n=i.call(this)||this,r=e||function(){for(var e;e=prompt("请按 2006-01-02 的格式输入第一天上课的日期"),!s.isValidDay(e););var t=new Date(e),n=t.getDay();return 1!==n&&(0===n?t.setDate(t.getDate()-6):t.setDate(t.getDate()-n+1)),t.toISOString().split("T")[0]}();n.firstDay=r;var a=t||s.semesterToWeeksMapping[document.querySelector(".span_currentUserInfo font").textContent.match(/[春夏秋冬]/)[0]];return n.weeks=a,n}return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}(s,i),s.isValidDay=function(e){return 3===e.split("-").length&&(!/[T:]/.test(e)&&!isNaN(Date.parse(e)))},s.combine=function(e,t){return new Date(e.toISOString().split("T")[0]+"T"+t+"+0800")},s.getCourse=function(){for(var e=new Array,t=document.querySelector(".tbllist"),n=0,r=Array.from(t.querySelectorAll("tr")).slice(3,-1);n<r.length;n++){var a=r[n],i=Array.from(a.querySelectorAll("td"));e.push({name:i[2].textContent.trim(),teacher:i[4].textContent.trim(),timeStr:i[6].textContent.trim(),location:i[7].textContent.trim()})}return e},s.prototype.getICSData=function(){for(var e=new c,t=0,n=s.getCourse();t<n.length;t++)for(var r=n[t],a=0,i=this.getTime(r.timeStr);a<i.length;a++){var o=i[a];e.addEvent(r.name,"教师："+r.teacher+"\\n"+r.timeStr,r.location,o.startTime,o.endTime)}return e.getCalendar()},s.prototype.getTime=function(e){for(var t,n=new Array;t=s.pattern.exec(e);){var r={weekday:s.weekdayMapping[t[1]],startTime:s.startTimeMapping[parseInt(t[2],10)],endTime:s.endTimeMapping[parseInt(t[3],10)],single:t[4],weekStart:parseInt(t[6],10),type:t[7],weekEnd:parseInt(t[8],10),week:parseInt(t[9],10)},a=new Date(this.firstDay);if(a.setDate(a.getDate()+r.weekday),isNaN(r.week))if(","===r.type)a.setDate(a.getDate()+7*(r.weekStart-1)),n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)}),a.setDate(a.getDate()+7*(r.weekEnd-r.weekStart)),n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)});else if("-"===r.type){a.setDate(a.getDate()+7*(r.weekStart-1));for(var i=0;i<r.weekEnd-r.weekStart+1;i++)n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)}),a.setDate(a.getDate()+7)}else if(["单","双"].includes(r.single)){"双"===r.single&&a.setDate(a.getDate()+7);for(i=0;i<this.weeks/2;i++)n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)}),a.setDate(a.getDate()+14)}else for(i=0;i<this.weeks;i++)n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)}),a.setDate(a.getDate()+7);else a.setDate(a.getDate()+7*(r.week-1)),n.push({startTime:s.combine(a,r.startTime),endTime:s.combine(a,r.endTime)})}return n},s.hostname=["xk.autoisp.shu.edu.cn"],s.semesterToWeeksMapping={"春":10,"夏":4,"秋":10,"冬":10},s.startTimeMapping={1:"08:00",2:"08:55",3:"10:00",4:"10:55",5:"12:10",6:"13:05",7:"14:10",8:"15:05",9:"16:00",10:"16:55",11:"18:00",12:"18:55",13:"19:50"},s.endTimeMapping={1:"08:45",2:"09:40",3:"10:45",4:"11:40",5:"12:55",6:"13:50",7:"14:55",8:"15:50",9:"16:45",10:"17:40",11:"18:45",12:"19:40",13:"20:35"},s.weekdayMapping={"一":0,"二":1,"三":2,"四":3,"五":4},s.pattern=new RegExp(String.raw(t||(t=e(["([一二三四五])(d{1,2})-(d{1,2})([单双s])?"],["([一二三四五])(\\d{1,2})-(\\d{1,2})([单双\\s])?"])))+String.raw(n||(n=e(["(s?((d{1,2})([,-])(d{1,2})周.*s?)|(第(d)周))?"],["(\\s?\\((\\d{1,2})([,-])(\\d{1,2})周.*\\s?\\)|\\(第(\\d)周\\))?"]))),"g"),s}(function(){}),m=Object.freeze({SHU:a});!function(){for(var e in m){var t=m[e];if(t.hostname.includes(location.hostname)){var n=(new t).getICSData(),r=new Blob([n],{type:"text/plain"}),a=URL.createObjectURL(r);return i=a,o="courses.ics",s=void 0,(s=document.createElement("a")).href=i,s.download=o,s.style.display="none",document.getElementsByTagName("body")[0].appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(a)}}var i,o,s;alert("暂不支持")}()}();
